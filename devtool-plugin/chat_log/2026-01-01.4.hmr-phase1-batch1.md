# RxJS HMR Instrumentation - Phase 1 Batch 1 Complete

## Goal

Build an HMR system for RxJS that mirrors React's pattern: keep subscriptions alive, swap function args on code change, next emission flows through new code naturally.

## Current State

- **Branch**: `feature/vite-instrumentation-v2`
- **Working**: Core tracking system + HMR types added
- **Plan file**: `/Users/chrishafley/.claude/plans/jazzy-juggling-sparrow.md`

## Solution/Approach

Using the executing-plans skill to implement Phase 1 in batches:
- Batch 1 (COMPLETE): Types and state infrastructure
- Batch 2 (NEXT): Runtime implementation + scan accumulator handlers
- Batch 3: Tests

Key architecture decisions from previous session:
- `hmr_track` is a separate layer referencing core entities via `entity_id`
- Events follow local consistency: `track-call` / `track-call-return` (not custom names)
- Parent track inferred from stack peek (not passed in event)
- `track-update` deferred to Phase 2

## Tasks

Completed:
- [x] Add `hmr_track` to `Hmm` type in `00.types.ts`
- [x] Add track event types to `ObservableEvent` union
- [x] Add `hmr_track` to `state$` initial value (stack + store)

Remaining:
- [ ] Create `src/tracking/v2/hmr/0_runtime.ts` - `__$` implementation
- [ ] Create `src/tracking/v2/hmr/1_queries.ts` - `deriveStructuralPath`
- [ ] Add track event handlers to `03_scan-accumulator.ts`
- [ ] Create `src/tracking/v2/hmr/0_runtime.test.ts` - validation tests

## Files Modified

- `src/tracking/v2/00.types.ts`:
  - Added `hmr_track` entity type (lines 110-118)
  - Added `track-call` / `track-call-return` events (lines 54-56)
  - Added `hmr_track` to stack and store initial values (lines 193, 204)

## Files to Create

- `src/tracking/v2/hmr/0_runtime.ts` - `__$`, TrackContext
- `src/tracking/v2/hmr/1_queries.ts` - `deriveStructuralPath`
- `src/tracking/v2/hmr/0_runtime.test.ts` - validation tests

## Key Insights

1. **Local consistency rule**: Events should follow `xyz-call` / `xyz-call-return` pattern, not custom names like `track-scope-start`
2. **Parent inference**: Parent track ID comes from stack peek, not event payload
3. **Phase 2 deferral**: `track-update` for HMR swap is unclear and deferred

## Open Questions

- Exact entity correlation logic in `track-call-return` handler
- How `$` child tracker determines index (auto-increment per parent scope)
