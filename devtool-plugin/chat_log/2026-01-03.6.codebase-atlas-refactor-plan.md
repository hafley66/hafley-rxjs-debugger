# 2026-01-03 - Codebase Atlas & FS Refactor Plan

## Goal
Create comprehensive codebase atlas for LLM ingestion + design two-phase plugin refactor

## Current State
- **Branch**: `feature/vite-instrumentation-v2`
- **Created**: `CODEBASE.md` at root - full architecture reference
- **Created**: `.claude/skills/hafley-fs-naming-preference.md` - naming convention skill

## Problem/Context
1. Codebase needs documentation that LLMs can ingest without re-reading everything
2. Current structure conflates two Vite plugin responsibilities (rxjs patching vs HMR transform)
3. File naming inconsistent (mixed `.` and `_`), not self-documenting

## Solution/Approach

### CODEBASE.md Atlas
- File tree with layer annotations and purpose descriptions
- Key exports tables with "Top 3 Callsites" column
- Dependency flow diagram (Layer 0→5)
- Core concepts: event-driven arch, state shape, HMR wrapper strategy

### Two-Phase Plugin Architecture
```
0_vite_plugin_rxjs_patch/     # Phase 0: Patch Observable.js + operators
1_tracking_runtime_events/    # Phase 1: Event→State accumulator
2_vite_plugin_hmr_transform/  # Phase 2: Wrap user code for HMR
3_ui_demo_app/                # Phase 3: Demo visualization
```

### Naming Convention
> **Name files so `ls` explains the system: `{order}_{what}_{how}_{keyidea}.ts`**

- Folders: underscores only (polyglot FS safe)
- Files: underscores for names, dots for extensions (.test.ts, .browser.test.tsx)

## Tasks
- [ ] Execute FS refactor (split v2.ts, rename files/folders)
- [ ] Update ~50 import paths after rename
- [ ] Continue Phase 5.1: Hierarchical path tracking
- [ ] Continue Phase 5.2: Extended scope detection (future)

## Files to Modify
- `CODEBASE.md` - NEW, comprehensive atlas
- `.claude/skills/hafley-fs-naming-preference.md` - NEW, naming skill

## Key Insights
1. **FS = Documentation** - File paths should explain architecture without opening files
2. **Two-phase plugin** - Separate rxjs patching (library code) from HMR transform (user code)
3. **Naming pattern** - `{order}_{what}_{how}_{keyidea}.ts` compresses 3-5 ideas per name
4. **Polyglot folders** - Underscores only for cross-language filesystem compatibility

## Open Questions
- When to execute the big FS refactor? (lots of import updates)
- Phase 5.1 hierarchical paths design still pending implementation

## Quick Reference
| File | Purpose |
|------|---------|
| `CODEBASE.md` | Architecture atlas, refactor plan |
| `.claude/skills/hafley-fs-naming-preference.md` | Naming convention for AI |
| `chat_log/epics/hmr-mvp/board.md` | Epic status board |
