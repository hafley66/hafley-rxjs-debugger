# 2026-01-04 - transitive-factory-detection

## Goal
Enhance the Vite transform to detect user-defined factory functions that return observables, enabling automatic `__$` wrapping for better tracking coverage.

## Current State
- **Branch**: `feature/vite-instrumentation-v2`
- **Committed**: `272f9df fix: synchronous bootstrap and shareReplay for proper HMR tracking`
- **Working**: Kitchen sink test passes, all unit tests pass (68+17)
- **Key file**: `src/vite-plugin/0_user-transform.ts`

## Problem/Context
Current transform only recognizes direct RxJS patterns:
```ts
const x$ = of(1)           // ✓ Wrapped
const y$ = new Subject()   // ✓ Wrapped

// BUT NOT:
function createData$() { return of(1) }
const data$ = createData$()  // ✗ NOT wrapped
```

Also: function-internal observables are skipped entirely (via `shouldSkip`).

## Solution/Approach
**Taint Tracking** - propagate "marked as observable" through assignments:

1. **Seed** marked set with RxJS imports (`of`, `from`, `Subject`, etc.)
2. **Propagate** marks through:
   - Variable declarations: `const a = of(1)` → `a` is marked
   - Assignments: `b = a` where `a` is marked → `b` is marked
   - Function returns: `return a` where `a` is marked → function is marked
   - Class methods: same as functions
3. **Iterate** until no new marks (handles transitive deps)
4. **Remove `shouldSkip`** for function bodies - wrap inside functions too
5. **Scope-prefixed keys**: `foo:y$:of(1)` for nested tracking

## Tasks
- [ ] Add `isMarkedExpression()` checker function
- [ ] Add `getReturnExpressions()` helper
- [ ] Add `buildMarkedSet()` with taint propagation loop
- [ ] Update `collectTargets()` to use unified marked set
- [ ] Remove `shouldSkip` logic for function bodies
- [ ] Add scope stack tracking for key prefixes
- [ ] Update `transformUserCode()` entry point
- [ ] Add tests for new patterns

## Files to Modify
- `src/vite-plugin/0_user-transform.ts` - Main implementation
- `src/vite-plugin/__tests__/user-transform.test.ts` - Add tests

## Key Insights
- **React parallel**: JSX return type → Component, Observable return type → Factory
- **`__$` is the decorator**: wrapping IS the marking
- **Scope prefix**: `foo:bar:x$:of(1)` gives tree structure in debugger
- **No TS needed**: Syntactic flow analysis gets 90% coverage

## Open Questions
- None - plan approved and ready for implementation

## Plan File
Full implementation details in: `/Users/chrishafley/.claude/plans/fuzzy-whistling-tarjan.md`
