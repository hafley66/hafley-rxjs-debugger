# 2026-01-05 - fix-sharereplay-hmr-buffer-final

## Goal
Fixed shareReplay buffer persistence bug and stabilized HMR integration tests. Session complete.

## Current State
- **Branch**: `feature/vite-instrumentation-v2`
- **Status**: All committed, working tree clean
- **Tests**: 92 v2 tracking tests pass, 4 HMR integration tests pass

## Commits This Session
- `8b86a92` - fix: trackedObservable prefers current store value over stale initialMutableId
- `1a4fef2` - docs: add store-first lookup invariant and document bug fix
- `910bc6f` - test: make HMR integration tests more stable with waitFor patterns
- `b77a174` - docs: add session logs for shareReplay HMR fix

## Problem/Context
1. **shareReplay buffer bug**: Late subscriber after HMR got `[2, 3, 10]` instead of `[10]`
   - Root cause: `trackedObservable` used `initialMutableId ?? store.value` priority
   - `initialMutableId` captured at wrapper creation, stayed stale after HMR
2. **Flaky integration tests**: Used `setTimeout(3000)` instead of proper `waitFor`

## Solution/Approach
1. Reversed priority to `store.value ?? initialMutableId` in both `tryConnect()` and `watchSub`
2. Added `waitForTestReady()` helper and `page.waitForFunction()` patterns to Playwright tests

## Tasks
- [x] Debug and fix shareReplay buffer persistence
- [x] Add "Store-first lookup" invariant to wiki
- [x] Stabilize HMR integration tests with waitFor
- [x] Commit all changes

## Files Modified
- `src/tracking/v2/hmr/2_tracked-observable.ts`
- `src/tracking/v2/rxjs-edge-cases/shareReplay.test.ts`
- `wiki/hmr-tracked-observable-test-matrix.md`
- `src/vite-plugin/__tests__/hmr-integration/hmr.integration.test.ts`

## Key Insights
- Closure-captured values stay stale when wrapper is reused across HMR
- `a ?? b` prefers `a` if truthy - wrong when `a` is stale but defined
- Playwright: always use `waitForFunction()` over `setTimeout`

## Next Steps (User's Roadmap)
- [ ] UI development - Chrome Network Tab inspired design
- [ ] Refactor Vite plugin: separate instrumentation debugger from HMR
- [ ] Clean up test app debugger
- [ ] Playwright screenshot coverage for UI
- [ ] Integrate into personal website with existing RxJS tools
