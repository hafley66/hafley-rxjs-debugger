# 2026-01-03 - Vite Transform Test Gaps & Nested Scope Design

## Goal
1. Fix test coverage gaps in user transform (aliased imports, namespace imports, class properties)
2. Design hierarchical path tracking for nested observables (switchMaps, subscribe callbacks)

## Current State
- **Branch**: `feature/vite-instrumentation-v2`
- **Commits**:
  - `c90b5f5` - fix: handle aliased imports, namespace imports, and class properties
  - `4e7f4ee` - feat: add user code AST transform for HMR observable tracking
- **Tests**: 121 passing, 3 skipped (36 in user-transform.test.ts)

## Problem/Context
1. **Test gaps identified**: Aliased imports, namespace imports, class properties were bugs
2. **User request**: Need hierarchical paths for deeply nested observables (switchMaps, manual subscribes)

## Solution/Approach

### Part 1: Test Gap Fixes (DONE)
Fixed 3 bugs in `0_user-transform.ts`:
- **Aliased imports**: Check `imported.name` against known creators, add `local.name` to set
- **Namespace imports**: Handle `ImportNamespaceSpecifier`, detect `rx.of()` member expressions
- **Class properties**: Added `PropertyDefinition` detection alongside `VariableDeclarator`

### Part 2: Nested Scope Design (PLANNED)
**Hybrid approach**: Transform stays module-scope only, runtime derives hierarchical paths from stack context

Path format: `{parentTrack}/{operator}[{index}].{callbackArg}:{varName}:{hash}`

Example: `source$/switchMap[0].0:inner`

## Tasks
- [x] Analyze test coverage gaps
- [x] Fix aliased imports bug
- [x] Fix namespace imports bug
- [x] Fix class properties bug
- [x] Add 9 new tests (high priority gaps + hash collisions)
- [x] Document gaps in `test-gaps.md`
- [x] Design hierarchical path tracking
- [x] Save design to `nested-scope-design.md`
- [ ] Implement Phase 5.1: Hierarchical Path Tracking

## Files Modified
- `src/vite-plugin/0_user-transform.ts` - Fixed aliased/namespace/class bugs
- `src/vite-plugin/__tests__/user-transform.test.ts` - Added 9 tests
- `chat_log/epics/hmr-mvp/board.md` - Added Phase 5.1
- `chat_log/epics/hmr-mvp/vite-transform/test-gaps.md` - Created gap analysis
- `chat_log/epics/hmr-mvp/vite-transform/nested-scope-design.md` - Created design doc

## Key Insights
1. **Import verification**: Must check `spec.imported.name` (original) against known creators, then track `spec.local.name` (aliased) in the set
2. **Namespace imports**: Need `ImportNamespaceSpecifier` handling + MemberExpression detection for `rx.of()`
3. **Hash collisions**: Same content hash is OK - var name prefix makes keys unique
4. **Hybrid approach chosen**: Transform stays simple, runtime derives structural paths from existing stack (operator_fun, arg_call, subscription)

## Open Questions
- Should structural_path be computed lazily or stored eagerly?
- How to handle dynamic per-call observables with same key?

## Phase 5.1 Implementation (Next)
Files to modify:
1. `src/tracking/v2/00.types.ts` - Add structural_path, parent_operator, parent_callback
2. `src/tracking/v2/hmr/0_runtime.ts` - Enhance __$ location derivation
3. `src/tracking/v2/03_scan-accumulator.ts` - Add structural_path in track-call-return
4. `src/tracking/v2/hmr/0_runtime.test.ts` - Add hierarchical path tests
