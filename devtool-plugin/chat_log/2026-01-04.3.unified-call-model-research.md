# 2026-01-04 - unified-call-model-research

## Goal
Design normalized relational data model for RxJS debugger, collapsing 11 tables → 5 (3 core + 2 HMR).

## Current State
- **Branch**: `feature/vite-instrumentation-v2`
- **Working**: Current tracking with 11 entity types
- **Key files**:
  - `src/tracking/v2/00.types.ts` - Current types
  - `src/tracking/v2/03_scan-accumulator.ts` - Event handlers
  - `chat_log/plans/2026-01-04.0.unified-call-model.md` - Full plan saved

## Problem/Context
Current model has redundant entity types all representing "function invocation producing observable":
- `operator_fun`, `operator`, `pipe`, `arg_call`, `send`, `subscription`
- All can unify into `call` with `kind` discriminator

## Solution/Approach

### Final Model: 3 core + 2 HMR tables

```typescript
type Call = {
  id, created_at, created_at_end?
  kind: "factory" | "operator" | "pipe" | "callback" | "subscribe" | "unsubscribe" | "next" | "error" | "complete"
  parent_id?         // FK → call (from CALL stack)
  subscription_id?   // FK → call WHERE kind='subscribe' (from SUBSCRIPTION stack)
  observable_id?     // FK → observable (denorm)
  index?
  is_sync?, sub_ref?, module_id?
}

type Arg = {
  id, call_id, path, index
  value?, observable_id?, fn_ref?
}

type Observable = { id, created_at, obs_ref? }
```

### Critical: Two Stacks
- **Call stack** → `parent_id` (structural nesting)
- **Subscription stack** → `subscription_id` (runtime context)
- Orthogonal: can be in sub context while nested in different call

### Key Decisions
- `observable_id` on call = what method was called ON
- `$return` arg = what call PRODUCES
- Factory has no observable_id
- Sends have observable_id for query efficiency

## Tasks
- [ ] Create git worktree: `../hafley-rxjs-debugger-unified`
- [ ] Fix `entity_id` bug in `06_queries.ts:92`
- [ ] Create unified `Call`/`Arg` types
- [ ] Update accumulator with two-stack context
- [ ] Write nested pipe test
- [ ] Update root observable/subscription queries

## Files to Modify
- `src/tracking/v2/00.types.ts` - Unified types
- `src/tracking/v2/03_scan-accumulator.ts` - Handlers, two stacks
- `src/tracking/v2/06_queries.ts` - Bug fix, helpers

## Key Insights
1. **11 → 5 tables** - everything is a "call"
2. **parent_id ≠ subscription_id** - different stacks
3. **$path convention**: `$args.0`, `$return`, `$args.0.next.$args.0`
4. **6 lifecycle events** (tap): subscribe, unsubscribe, next, error, complete
5. **Nullable FKs OK** - orthogonal dimensions

## Open Questions
- Pipe observable_id: input vs output? → Input, $return handles output
- Full plan: `chat_log/plans/2026-01-04.0.unified-call-model.md`
