# Chat Log: Vite Plugin & Auto-Instrumentation
**Date:** 2025-12-26
**Session:** 2
**Topic:** Vite plugin for auto-injecting track$ annotations using oxc-parser

---

## Summary

Built a Vite plugin that auto-instruments RxJS code with tracking metadata. Uses oxc-parser for fast AST parsing and magic-string for code injection with sourcemaps. Also created comprehensive deterministic tests for the transform function.

---

## Key Accomplishments

### 1. Vite Plugin (`src/vite-plugin/rxjs-track-plugin.ts`)

Transforms RxJS code to inject `__track$` calls with file/line/variable metadata:

**Before:**
```typescript
const data$ = of(1, 2, 3);
const result$ = source$.pipe(map(x => x * 2));
```

**After:**
```typescript
import { __track$ } from 'rxjs-debugger/track';
const data$ = __track$(of(1, 2, 3), {n:'data$',f:'src/app.ts',l:5});
const result$ = __track$(source$.pipe(map(x => x * 2)), {n:'result$',f:'src/app.ts',l:6});
```

**Features:**
- Uses oxc-parser (Rust-based, 4x faster than swc) for AST detection
- Falls back to regex detection if oxc unavailable
- magic-string for code injection with sourcemap preservation
- Detects: of, from, interval, timer, Subject, BehaviorSubject, combineLatest, merge, .pipe()
- Excludes node_modules by default
- Configurable include/exclude patterns and trackImport source

### 2. Compact Track Function (`src/tracking/track.ts`)

Added `__track$<T>(obs: T, meta: CompactMeta): T` for auto-instrumentation:

```typescript
interface CompactMeta {
  n: string;  // name
  f?: string; // file
  l?: number; // line
}
```

Minimal overhead, expands to full metadata format internally.

### 3. Deterministic Plugin Tests

Created `src/vite-plugin/__tests__/rxjs-track-plugin.test.ts`:

- Tests transform function directly without full vite build
- 17 tests covering all RxJS patterns
- Verifies line numbers, sourcemaps, import injection
- Tests custom options (include pattern, trackImport)
- All tests passing

---

## Technical Details

### Plugin Architecture

```typescript
export function rxjsTrackPlugin(options = {}): Plugin {
  let parseSync: ((filename, code, options) => OxcParseResult) | null = null;

  return {
    name: 'rxjs-track',
    enforce: 'pre',

    async buildStart() {
      const oxc = await import('oxc-parser');
      parseSync = oxc.parseSync;
    },

    async transform(code, id) {
      // 1. Quick check for rxjs imports
      // 2. Parse AST with oxc-parser
      // 3. Walk AST for variable declarations with RxJS calls
      // 4. Use magic-string to inject __track$ wrappers
      // 5. Return transformed code with sourcemap
    },
  };
}
```

### AST Detection Patterns

- `const x$ = of(...)` - CallExpression with RXJS_CREATORS
- `const x$ = new Subject()` - NewExpression with Subject types
- `const x$ = source$.pipe(...)` - CallExpression with MemberExpression callee ending in `.pipe`

### Regex Fallback

Three patterns for when oxc unavailable:
1. `/const\s+(\w+\$?)\s*=\s*(of|from|interval|...)\s*\(/`
2. `/const\s+(\w+\$?)\s*=\s*new\s+(Subject|BehaviorSubject|...)\s*\(/`
3. `/const\s+(\w+\$?)\s*=\s*(\w+)\$?\.pipe\s*\(/`

---

## Files Created/Modified

| File | Action | Purpose |
|------|--------|---------|
| `src/vite-plugin/rxjs-track-plugin.ts` | CREATE | Main plugin implementation |
| `src/vite-plugin/index.ts` | CREATE | Plugin exports |
| `src/vite-plugin/__tests__/rxjs-track-plugin.test.ts` | CREATE | Plugin transform tests |
| `src/tracking/track.ts` | MODIFY | Added `__track$` compact function |

---

## Test Results

```
✓ src/vite-plugin/__tests__/rxjs-track-plugin.test.ts (17 tests) 176ms
  ✓ should skip non-matching files
  ✓ should skip files without rxjs imports
  ✓ should transform of() creation
  ✓ should transform from() creation
  ✓ should transform interval() creation
  ✓ should transform new Subject()
  ✓ should transform new BehaviorSubject()
  ✓ should transform .pipe() calls
  ✓ should transform combineLatest()
  ✓ should transform merge()
  ✓ should add import statement
  ✓ should include line numbers
  ✓ should generate sourcemap
  ✓ should handle multiple declarations
  ✓ should skip node_modules by default
  ✓ should respect custom include pattern
  ✓ should respect custom trackImport
```

---

## Dependencies Added

- `oxc-parser` - Fast Rust-based JS/TS parser
- `magic-string` - Code manipulation with sourcemap support

---

## Usage

```typescript
// vite.config.ts
import { rxjsTrackPlugin } from 'rxjs-debugger/vite-plugin';

export default {
  plugins: [
    rxjsTrackPlugin({
      trackImport: 'rxjs-debugger/track',
      include: /\.[tj]sx?$/,
      exclude: /node_modules/,
    }),
  ],
};
```

---

## Next Steps

- Integration test with actual vite build
- Handle more edge cases (destructuring, re-exports)
- Consider esbuild plugin variant

---

**Session End**: Plugin complete and tested
