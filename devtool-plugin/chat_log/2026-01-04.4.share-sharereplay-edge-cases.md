# 2026-01-04 - share-sharereplay-edge-cases

## Goal
Create comprehensive test coverage for share/shareReplay operators and document HMR edge cases in a wiki.

## Current State
- **Branch**: `feature/vite-instrumentation-v2`
- **Commit**: `bd2f47d` - test: add share/shareReplay edge case tests and HMR test matrix wiki

## What We Did

### Created `wiki/hmr-tracked-observable-test-matrix.md`
Comprehensive documentation of:
- Instance invariants for trackedObservable, trackedSubject, trackedBehaviorSubject
- Completion patterns (sync vs async)
- Sync replay edge cases (BehaviorSubject re-entrancy)
- **Multicasting (share/shareReplay)** - full test matrix with configs
- Arg patterns, higher-order operators, notifier timing
- Async functions as args (requires syntax transform)
- HMR lifecycle
- Current test coverage matrix with gaps identified

### Created `src/tracking/v2/rxjs-edge-cases/`
New folder for focused RxJS operator tests:

**share.test.ts** (11 tests):
- Basic multicast, late subscriber misses values
- `resetOnRefCountZero`, `resetOnComplete`, `resetOnError` configs
- Custom connector with ReplaySubject
- HMR tracking - works correctly

**shareReplay.test.ts** (13 tests):
- Basic replay, multiple buffer size
- `refCount: true/false` behavior
- Operator ordering bug: `share()` before `startWith()`
- HMR tracking - mostly works
- Complete/error propagation

### Added transform tests
In `user-transform.test.ts`:
- Verifies Subject and pipe(shareReplay) are wrapped as **separate** tracked entities
- Key insight: `source$` in shared$'s factory is the STABLE wrapper

## Bug Discovered
`shareReplay buffer persists across HMR swaps` (marked `.fails`)

Expected: late subscriber after HMR gets `[10]` (only post-HMR values)
Actual: late subscriber gets `[2, 3, 10]` (old buffer + new values)

Root cause unclear - trackedObservable may not be switching correctly, or subscription chain preserves old buffer.

## Key Insight: Transform Produces Separate Entities

```typescript
// User code:
const source$ = new Subject<number>()
const shared$ = source$.pipe(shareReplay(1))

// Transform output:
const source$ = __$("source$:new Subject()", () => new Subject<number>())
const shared$ = __$("shared$:source$.shareReplay(1)", () => source$.pipe(shareReplay(1)))
```

On HMR:
1. `source$` (trackedSubject) swaps inner Subject
2. `shared$` (trackedObservable) re-runs factory with STABLE `source$`
3. Creates NEW shareReplay connected to stable wrapper
4. Fresh buffer, no stale state (in theory - bug found)

## Files Modified
- `src/tracking/v2/rxjs-edge-cases/share.test.ts` (new)
- `src/tracking/v2/rxjs-edge-cases/shareReplay.test.ts` (new)
- `src/vite-plugin/__tests__/user-transform.test.ts` (+83 lines)
- `wiki/hmr-tracked-observable-test-matrix.md` (new)

## Tasks
- [x] Create wiki test matrix document
- [x] Add share/shareReplay section to wiki
- [x] Create rxjs-edge-cases test folder
- [x] Write share.test.ts
- [x] Write shareReplay.test.ts
- [x] Add transform tests for share patterns
- [x] Investigate and fix shareReplay buffer persistence bug

## Bug Fix: shareReplay Buffer Persistence

**Symptom**: Late subscriber after HMR gets `[2, 3, 10]` instead of `[10]` (stale buffer)

**Root Cause**: `trackedObservable` used `initialMutableId ?? store.value` priority.
- `initialMutableId` is captured at wrapper creation (first HMR run)
- After HMR swap, store has new `mutable_observable_id`
- But `initialMutableId` was truthy, so store value was never checked
- New subscribers connected to OLD observable, getting stale shareReplay buffer

**Fix**: Reverse priority to `store.value ?? initialMutableId`
- Current store value is always preferred
- `initialMutableId` only used as fallback before store is populated

**Commit**: `8b86a92`
