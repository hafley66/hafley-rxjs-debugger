# Session: Store-Based Tracking Refactor

## Goal
Refactor subscription tracking to use store-based checks and `__id__` propagation instead of global `isEnabled$` flag for everything.

## Current State
- **Branch**: `feature/vite-instrumentation-v2`
- **Tests**: 130 passing, 3 skipped
- **Commit**: `977f94f` - refactor: store-based subscription tracking with __id__ propagation

## Problem/Context
1. Defer factory bug: values weren't flowing through nested `__$` calls
2. `isEnabled$` was a blunt global kill switch blocking ALL events
3. Needed cleaner model where tracking is relational (store-based)

## Solution/Approach

### 1. Observable `__id__` (DONE)
- Constructor patch: `__id__ = __isEnabled__() ? __createId__() : ""`
- If `isEnabled()` is false at creation, observable gets `__id__ = ""`
- No wasted IDs on untracked observables

### 2. Subscription `__id__` (DONE)
- patchedSubscribe checks: `isEnabled() && obs_id && store.observable[obs_id]`
- If any condition fails, subscription gets `__id__ = ""` and passes through
- Subscriptions inherit trackedness from their observable

### 3. UNTRACKED_EVENTS fix (DONE)
- `shouldEmit` now checks UNTRACKED_EVENTS FIRST (before enabled check)
- Allows `track-call` events through even when `isEnabled$=false`
- Fixes defer factory - nested `__$` calls now work

### 4. Bootstrap extended (DONE)
- Added `getStore` and `getStack` parameters
- patchedSubscribe can now check `store.observable[obs_id]`

## Tasks
- [x] Fix defer factory bug
- [x] Add `__isEnabled__` export for constructor injection
- [x] Update constructor patch to conditionally create IDs
- [x] Update patchedSubscribe with store-based checks
- [x] Attach `__id__` to subscriptions
- [x] Update bootstrap to pass getStore/getStack
- [x] Run tests and update snapshots

## Files Modified
- `src/tracking/v2/01.patch-observable.ts` - Store-based subscribe, `__isEnabled__` export
- `src/tracking/v2/00.types.ts` - Bootstrap call with getStore/getStack
- `src/vite-plugin/v2.ts` - Conditional `__id__` creation in constructor
- `src/tracking/v2/03_scan-accumulator.ts` - Plumbing detection, stable_ref removal
- `src/tracking/v2/hmr/2_tracked-observable.ts` - Removed DEBUG_CONFIG
- `src/tracking/v2/hmr/6_plumbing-detection.test.ts` - New plumbing detection tests

## Key Insights
1. **`isEnabled` controls instance creation** - observables AND subscriptions
2. **Empty `__id__` = not tracked** - propagates through the system
3. **Store presence = tracked via `__$`** - relational model
4. **UNTRACKED_EVENTS must be checked first** - before enabled state
5. **Wrapperâ†’inner subscriptions ARE tracked** - UI filters by metadata, not by skipping tracking

## Open Questions
- Should we add tags to internal subscriptions for UI filtering?
- Consider removing plumbing detection in accumulator since we have `isEnabled()` check now?
