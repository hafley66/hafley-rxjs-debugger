#!/bin/bash

# Claude Code Docker Wrapper
# Run Claude Code in Docker using current directory as workspace

set -e

# Configuration
IMAGE_NAME="claude-code:latest"
CONTAINER_NAME_PREFIX="claude-code"

# Colors
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m'

# Generate unique container name based on current directory
CURRENT_DIR_HASH=$(echo "$(pwd)" | md5sum | cut -c1-8 2>/dev/null || echo "$(pwd)" | md5 | cut -c1-8)
CONTAINER_NAME="${CONTAINER_NAME_PREFIX}-${CURRENT_DIR_HASH}"

# Check if image exists
if ! docker image inspect "$IMAGE_NAME" >/dev/null 2>&1; then
    echo -e "${RED}Error: Docker image '$IMAGE_NAME' not found${NC}"
    echo -e "${YELLOW}Please build the image first:${NC}"
    echo -e "  cd $(dirname "$0")"
    echo -e "  docker build -t $IMAGE_NAME ."
    exit 1
fi

# Function to check if container exists and is running
container_status() {
    if docker ps -a --format '{{.Names}}' | grep -q "^${CONTAINER_NAME}$"; then
        if docker ps --format '{{.Names}}' | grep -q "^${CONTAINER_NAME}$"; then
            echo "running"
        else
            echo "stopped"
        fi
    else
        echo "none"
    fi
}

# Parse command
COMMAND="${1:-bash}"
shift || true

STATUS=$(container_status)

case "$STATUS" in
    "running")
        echo -e "${GREEN}→ Attaching to running container: $CONTAINER_NAME${NC}"
        docker exec -it "$CONTAINER_NAME" "$COMMAND" "$@"
        ;;

    "stopped")
        echo -e "${YELLOW}→ Starting stopped container: $CONTAINER_NAME${NC}"
        docker start "$CONTAINER_NAME" >/dev/null
        docker exec -it "$CONTAINER_NAME" "$COMMAND" "$@"
        ;;

    "none")
        echo -e "${BLUE}→ Creating new container: $CONTAINER_NAME${NC}"
        echo -e "${BLUE}→ Workspace: $(pwd)${NC}"

        # Create and run container
        docker run -it --rm \
            --name "$CONTAINER_NAME" \
            -v "$(pwd):/workspace" \
            -v claude-data-"${CURRENT_DIR_HASH}":/root/.claude \
            -e "ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}" \
            -w /workspace \
            "$IMAGE_NAME" \
            "$COMMAND" "$@"
        ;;
esac
