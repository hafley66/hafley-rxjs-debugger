# React ↔ RxJS HMR Architecture Discussion

Date: 2026-01-04
Branch: `feature/vite-instrumentation-v2`

## Goal

Understand and finalize the HMR architecture for the RxJS debugger Vite plugin, specifically:
- How `__$` instrumentation works and its limitations
- How HMR swap/orphan detection should behave
- Key identity strategy (content hash vs variable name)

## Current State

**Working (~80% MVP):**
- AST transform (`0_user-transform.ts`) - wraps module-level observables/subs
- Runtime tracking (`hmr/0_runtime.ts`) - events emit correctly
- trackedObservable/trackedSubject wrappers - stable proxy pattern
- Scan accumulator - state management, orphan detection via prev_keys diff
- Observable patching - IIFE-aware, double-patch protection
- **HMR self-accept injection** - `import.meta.hot.accept()` injected
- **Structural keys** - mirrors runtime naming: `of(1,2,3).map(fn)`
- **Subscription cleanup on orphan** - via `sub_ref: WeakRef<Subscription>`

**Key Files:**
- `src/vite-plugin/v2.ts` - main plugin
- `src/vite-plugin/0_user-transform.ts` - AST transform (41 tests)
- `src/tracking/v2/hmr/0_runtime.ts` - `__$` runtime
- `src/tracking/v2/hmr/2_tracked-observable.ts` - HMR swap mechanism
- `src/tracking/v2/03_scan-accumulator.ts` - state management

## Completed This Session

### 1. HMR Self-Accept Injection
Transform now injects at end of every transformed module:
```js
if (import.meta.hot) {
  import.meta.hot.accept()
}
```

### 2. Subscription Cleanup on Orphan
- Added `sub_ref: WeakRef<Subscription>` to subscription entity
- Pass `subscription` in `subscribe-call-return` event
- On orphan detection (track key not re-registered), unsubscribe via `sub_ref`

### 3. Structural Keys (replacing content hash)
Keys now mirror runtime observable naming:
- `of(1,2,3)` → key: `"data$:of(1,2,3)"`
- `new Subject()` → key: `"events$:new Subject()"`
- `source$.pipe(map(fn))` → key: `"doubled$:source$.map(fn)"`
- `data$.subscribe(console.log)` → key: `"sub:data$.subscribe(console.log)"`

Functions serialize to `fn`, variable refs use identifier name (more stable for HMR).

## Key Architectural Insight: React Fiber Parallel

| React | RxJS |
|-------|------|
| Component | Observable |
| ReactDOM.render() | .subscribe() |
| Fiber tree | Subscription chain |
| HOC | pipe() |
| React.memo | trackedObservable |
| Fast Refresh | Our HMR swap |
| `$RefreshReg$` | `__$()` wrapper |
| Hook signature | Structural key |

**Subscribe IS render.** We're building the reconciler.

## Tasks

- [x] Inject `import.meta.hot.accept()` in transform output
- [x] Decide key strategy → Structural keys (like React hook signatures)
- [x] Subscription cleanup on orphan via `sub_ref`
- [ ] Add real Vite dev server integration test
- [ ] Basic error handling in `__$` runtime
- [ ] Document the React parallel mental model

**Deferred:**
- [ ] Nested lazy observable tracking (require manual `$()` for now)
- [ ] Class method observables
- [ ] DevTools UI

## Key Insights

1. **Subscribe = render** - activation point, mount of subscription chain
2. **Pipe = HOC** - each operator is a component ID
3. **trackedObservable = React.memo** - stable wrapper, swappable inner
4. **Structural keys** - like React hook signatures, captures call structure not values
5. **Variable refs → identifier name** - more stable than values for HMR
6. **IIFEs are a gap** - same as React Refresh, workaround: assign to variable
7. **React Refresh parallel** - we're doing essentially the same thing, just detecting "is observable" instead of "has JSX"

## Commits This Session

1. `d495950` - feat: add HMR self-accept injection and subscription cleanup on orphan
2. `9cc8846` - feat: replace content hash keys with structural keys in transform

## Next: Integration Test

Need a real Vite dev server test that:
1. Starts Vite in dev mode
2. Loads a page with tracked observables
3. Modifies the source file
4. Verifies HMR swap worked (subscriptions survive, new values flow)
