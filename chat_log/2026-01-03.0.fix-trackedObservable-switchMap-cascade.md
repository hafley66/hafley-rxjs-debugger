# 2026-01-03 - fix-trackedObservable-switchMap-cascade

## Goal
Fix the switchMap callback double-invocation bug in the HMR tracking system where `response$.next(42)` was incorrectly triggering `trigger$`'s switchMap callback a second time.

## Current State
- **Branch**: `feature/vite-instrumentation-v2`
- **Status**: All 63 v2 tests passing
- **Key files modified**:
  - `src/tracking/v2/hmr/2_tracked-observable.ts`
  - `src/tracking/v2/03_scan-accumulator.ts`
  - `src/tracking/v2/hmr/0_runtime.ts`

## Problem/Context
When using `trackedObservable` with `switchMap`, calling `.next()` on the response observable was causing the switchMap callback to fire again:

```
trigger$.next("go")     // Expected: callback fires once with "go/0"
response$.next(42)      // BUG: callback fires AGAIN with "42/1"
                        // Expected: value 42 flows through to subscriber
```

**Root cause**: `trackedObservable` was calling `isEnabled$.next(true)` before subscribing to inner observable. This:
1. Enabled tracking during subscribe chain
2. Created subscribe-call events
3. Triggered `state$$` emissions
4. All `trackedSubject` watchers fired
5. Cascading state changes confused the subscription chain

## Solution/Approach
1. **Don't enable tracking in trackedObservable**: Push module/track context to stacks (for defer factory context) but DON'T set `isEnabled$.next(true)` - prevents subscribe events from cascading

2. **Use stable wrapper ID for sends**: Changed `send-call` handler to use `originTrack.id` (wrapper's stable ID) instead of `event.observable_id` (inner's ephemeral ID)

3. **Cleanup**: Removed all debug logging from production code

## Tasks
- [x] Fix trackedObservable cascade by removing isEnabled$.next(true)
- [x] Fix send attribution to use stable wrapper ID
- [x] Clean up debug logging from all files
- [x] Verify all 63 tests pass

## Files Modified
- `src/tracking/v2/hmr/2_tracked-observable.ts` - Removed `isEnabled$.next(true)`, debug logging
- `src/tracking/v2/03_scan-accumulator.ts` - Use `originTrack.id` in send-call, debug logging
- `src/tracking/v2/hmr/0_runtime.ts` - Removed debug logging

## Key Insights
1. **Event cascades are dangerous**: Code that enables tracking + does observable ops → state$$ emissions → ALL watchers fire
2. **Context stacks vs isEnabled$**: Push context for defer factories without enabling event emission
3. **Stable IDs for sends**: Reference wrapper's track ID, not inner's ephemeral ID
4. **Isolation tests are valuable**: Minimal tests identified trackedObservable as culprit

## Open Questions
- `suppressSend$` and `__withNoSend` are defined but unused - could remove
- trackedObservable watchers fire frequently - could optimize with distinctUntilChanged
