# 2026-01-12 - vite-plugin-split-refactor

## Goal
Refactor v2 codebase: split monolithic v2.ts Vite plugin into separate devtool + HMR plugins, flatten scattered datestamped files.

## Current State
- **Branch**: `main`
- **Tests**: 163 passing
- **Status**: All committed, working tree clean (minus pre-existing src/index.ts changes)

## Problem/Context
1. `vite-plugin/v2.ts` conflated two concerns: RxJS patching (devtool) and user code HMR transforms
2. Datestamped docs scattered across `tasks/`, `wiki/`, `chat_log/epics/`, `chat_log/plans/` etc.
3. File naming inconsistent

## Solution/Approach
1. Split v2.ts into composable plugins:
   - `0_rxjs_devtool_patch_plugin.ts` - standalone RxJS patching
   - `1_rxjs_hmr_plugin.ts` - composes devtool + user code transform via hook delegation
2. Flatten all datestamped files into `chat_log/` root
3. Archive old task docs to `chat_log/archive/`

## Tasks
- [x] Archive tasks/ to chat_log/archive/
- [x] Move wiki/ to chat_log/ with datestamp
- [x] Flatten chat_log subfolders (epics/, plans/, mvp/, angular/, tasks/)
- [x] Create 0_rxjs_devtool_patch_plugin.ts
- [x] Create 1_rxjs_hmr_plugin.ts (composes devtool via delegation)
- [x] Rename 0_user-transform.ts to 2_user_transform.ts
- [x] Update all imports
- [x] Delete old v2.ts
- [ ] Clean up legacy index.ts and rxjs-track-plugin.ts
- [ ] Phase 3: Reorganize src/ into 4-phase structure per CODEBASE.md
- [ ] Rename files to self-documenting convention

## Files Modified
- `src/vite-plugin/0_rxjs_devtool_patch_plugin.ts` - NEW
- `src/vite-plugin/1_rxjs_hmr_plugin.ts` - NEW (composes devtool)
- `src/vite-plugin/2_user_transform.ts` - RENAMED from 0_user-transform.ts
- `src/vite-plugin/v2.ts` - DELETED
- `vite.config.ts`, `vitest.config.ts`, `vitest.browser.config.ts` - updated imports
- `src/vite-plugin/__tests__/*/vite.config.ts` - updated imports
- `chat_log/` - flattened structure

## Key Insights
1. Vite plugins compose via hook delegation: create inner plugin, call its hooks from outer
2. `rxjsHmrPlugin` returns single `Plugin`, not `Plugin[]` - cleaner consumer API
3. Hook delegation pattern: `devtool.transform?.call(this, code, id)`

## Open Questions
- When to tackle Phase 3 src/ restructure? (multi-session effort)
- Keep or delete legacy rxjs-track-plugin.ts?

## New Plugin Structure
```
src/vite-plugin/
├── 0_rxjs_devtool_patch_plugin.ts  # Standalone devtools
├── 1_rxjs_hmr_plugin.ts            # Composes devtool + HMR
├── 2_user_transform.ts             # AST transform
├── index.ts                        # [LEGACY]
└── rxjs-track-plugin.ts            # [LEGACY]
```
