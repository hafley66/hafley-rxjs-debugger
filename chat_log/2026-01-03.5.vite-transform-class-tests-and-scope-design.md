# 2026-01-03 - Vite Transform Class Tests & Extended Scope Design

## Goal
1. Add tests for class `this.subscribe()` / `this.pipe()` patterns
2. Design extended scope detection for class methods and callback-scope observables

## Current State
- **Branch**: `feature/vite-instrumentation-v2`
- **Commits**:
  - `b4484b3` - test: add class this-reference tests and nested scope design doc
  - `c90b5f5` - fix: handle aliased imports, namespace imports, and class properties
- **Tests**: 41 in user-transform.test.ts

## Problem/Context
1. Classes extending BehaviorSubject have `this.subscribe()`, `this.pipe()` in methods
2. Transform skips these (inside function bodies) - correct for now
3. User wants to eventually wrap ALL rxjs patterns, not just module-scope
4. Need to distinguish module-scope vs callback-scope `__$` calls

## Solution/Approach

### Current (Implemented)
- 5 new tests for class patterns (all verify skip behavior)
- Extended Subject classes tracked at runtime via constructor patch, not compile-time

### Future (Documented in Phase 5.2)
1. **Class decoration marking** - config/decorator/static marker to auto-decorate class methods
2. **`is_module_scope` flag** - distinguish module-load vs callback-time `__$` calls
3. **Callback-scope lifecycle** - ephemeral, parent-linked cleanup, no duplicate-key warnings

## Tasks
- [x] Add 5 class this-reference tests
- [x] Document class patterns in test-gaps.md
- [x] Add Phase 5.2 to epic board
- [x] Expand nested-scope-design.md with extended scope section
- [ ] Implement Phase 5.1: Hierarchical path tracking
- [ ] Implement Phase 5.2: Extended scope detection (future)

## Files Modified
- `src/vite-plugin/__tests__/user-transform.test.ts` - 5 new tests
- `src/vite-plugin/__tests__/__snapshots__/user-transform.test.ts.snap` - External snapshots
- `chat_log/epics/hmr-mvp/board.md` - Added Phase 5.2
- `chat_log/epics/hmr-mvp/vite-transform/test-gaps.md` - Class patterns section
- `chat_log/epics/hmr-mvp/vite-transform/nested-scope-design.md` - Extended scope design

## Key Insights
1. **Extended classes NOT detected at compile-time** - only known RxJS classes (Subject, BehaviorSubject) are wrapped
2. **Runtime handles extended classes** - Observable constructor patch tracks all instances
3. **Module scope detection** possible via stack state: `!stack.send.length && !stack.subscription.length`
4. **Callback-scope observables** need different lifecycle - ephemeral, parent-linked

## Open Questions
- Should callback-scope tracks share keys or get unique keys per invocation?
- How to handle `defer(() => of(1))` which is lazy but module-level?
- Config vs decorator vs static marker for class decoration?

## Epic Status
| Phase | Status | Tests |
|-------|--------|-------|
| 5. Vite AST Transform | ✅ Done | 41 tests |
| 5.1 Hierarchical Paths | ⬜ Planned | 0 tests |
| 5.2 Extended Scope | ⬜ Future | 0 tests |
