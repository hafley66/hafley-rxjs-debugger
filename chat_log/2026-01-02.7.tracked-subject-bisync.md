# Session: trackedSubject bi-sync + dynamic observable naming

## Goal
Make `__$` return stable wrappers for both Observables and Subjects with proper HMR forwarding

## Current State
- **Branch**: `feature/vite-instrumentation-v2`
- **Tests**: 60 passing, 3 skipped (dangling subscription tests - follow-up)
- **Key commit**: Previous `feat: __$ returns trackedObservable for cold observables`

## What Was Implemented

### 1. trackedSubject for bi-sync forwarding
- New file: `src/tracking/v2/hmr/3_tracked-subject.ts`
- Returns stable proxy Subject that forwards `.next()`/`.error()`/`.complete()` to current inner Subject
- Also forwards `.subscribe()` to current inner Subject
- On HMR swap, proxy continues working with new inner Subject

### 2. Dynamic observable naming
- `__$` prepends subscription context when called inside send callback
- Format: `$ref[obsId]:subscription[subId]:location`
- Only at outermost level (checks `hasSubscriptionPrefix` to avoid double-prefixing)

### 3. Dangling subscription query
- `getDanglingSubscriptions()` in `06_queries.ts`
- Returns subscriptions to observables not in any `hmr_track.entity_id`
- Tests skipped pending more work

### 4. Fixed stable_ref timing
- Set `stable_ref` on stack entity directly (not queueMicrotask)
- Ensures repeated `__$` calls with same location return same stable reference

## Key Files Modified
- `src/tracking/v2/hmr/0_runtime.ts` - Updated `__$` for Subject handling + dynamic naming
- `src/tracking/v2/hmr/3_tracked-subject.ts` - NEW: bi-sync Subject wrapper
- `src/tracking/v2/06_queries.ts` - Added `getDanglingSubscriptions`
- `src/tracking/v2/hmr/0_runtime.test.ts` - New tests for dynamic naming
- `src/tracking/v2/hmr/2_tracked-observable.test.ts` - Fixed to use raw inner Subjects

## Key Insights

### Wrapper vs Raw distinction
```ts
a = __$('A', () => _a = new Subject())
_a.next(1) // a.sub sees this (raw inner Subject)

a = __$('A', () => _b = new Subject())  // HMR
_a.next(2) // a.sub does NOT see this (old raw is orphaned)
a.next(3)  // a.sub sees this (wrapper forwards to current)
```

- `wrapper$` = what `__$` returns (stable trackedSubject proxy)
- `rawInner$` = the raw Subject captured from factory
- After HMR: `wrapper$.next()` → new inner, `rawInner$.next()` on old → orphaned

### Send stack for subscription context
- During callbacks, subscription is on `state$.stack.send` (not subscription stack)
- send-call pushes origin track to hmr_track stack
- Check `hasSubscriptionPrefix` instead of `alreadyInTrack` to allow prefix in nested send

## Tasks
- [ ] Re-enable and fix dangling subscription tests
- [ ] Add test for trackedSubject bi-sync behavior specifically
- [ ] Consider: should trackedSubject also emit on proxy when inner emits? (currently doesn't)

## Open Questions
- Dangling detection with trackedSubject: when raw inner Subject is orphaned, how to detect/report?
