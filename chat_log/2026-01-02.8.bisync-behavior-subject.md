# Session: bi-sync trackedSubject + trackedBehaviorSubject

## Goal
Complete bi-directional sync for tracked subjects - inner↔proxy forwarding for `.next()`, `.error()`, `.complete()`

## Current State
- **Branch**: `feature/vite-instrumentation-v2`
- **Tests**: 69 passing, 3 skipped (dangling subscription tests)
- **Key files modified**:
  - `src/tracking/v2/hmr/3_tracked-subject.ts` - bi-sync implementation
  - `src/tracking/v2/hmr/0_runtime.test.ts` - bi-sync tests

## What Was Implemented

### 1. Full bi-sync for trackedSubject
- `innerSub` subscribes to inner Subject, forwards emissions to proxy
- `isForwarding` flag prevents infinite loops (proxy→inner→proxy)
- Works for `.next()`, `.error()`, `.complete()`

### 2. trackedBehaviorSubject
- Same bi-sync pattern as trackedSubject
- Added `.value` getter forwarding to current inner
- Added `.getValue()` method forwarding
- Initial value passed to proxy constructor
- Both use `__withNoTrack` for proxy creation (infrastructure, not user code)

### 3. Tests added
- `proxy.next forwards to inner and emits on proxy`
- `inner.next forwards to proxy (captured raw inner)`
- `error and complete forward bidirectionally`
- `inner.complete forwards to proxy`
- `no infinite loop when proxy.next triggers inner which triggers proxy`
- `getValue returns inner value`
- `proxy.next updates inner value`
- `inner.next updates proxy value`
- `bi-sync with next/error/complete`

## Key Insights

### Bi-sync flow with loop prevention
```ts
proxy.next = (value: T) => {
  if (inner) {
    isForwarding = true
    try { inner.next(value) }
    finally { isForwarding = false }
  }
  originalNext(value)
}

// Inner subscription (only forwards when !isForwarding)
innerSub = inner.subscribe({
  next: (v) => { if (!isForwarding) originalNext(v) }
})
```

### Subscription tracking limitation
- Subscriptions outside `__$` scope aren't tracked (by design)
- `shouldEmit` requires track context for `subscribe-call` events
- `fakeTrack: true` test option had isolation issues between describe blocks
- getDanglingSubscriptions tests skipped pending investigation

## Tasks
- [x] Add inner→proxy forwarding for trackedSubject
- [x] Add `.error()` and `.complete()` bi-sync
- [x] Add trackedBehaviorSubject with `.value`/`.getValue()`
- [x] Add comprehensive bi-sync tests
- [ ] Investigate fakeTrack test isolation issue for dangling tests

## Open Questions
- Why does `fakeTrack: true` not isolate properly between vitest describe blocks?
- Should subscriptions outside `__$` be trackable via different mechanism?
