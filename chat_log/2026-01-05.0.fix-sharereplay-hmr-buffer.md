# 2026-01-05 - fix-sharereplay-hmr-buffer

## Goal
Fix shareReplay buffer persistence bug where late subscribers after HMR got stale buffer values instead of fresh post-HMR data.

## Current State
- **Branch**: `feature/vite-instrumentation-v2`
- **Commits**:
  - `8b86a92` - fix: trackedObservable prefers current store value over stale initialMutableId
  - `1a4fef2` - docs: add store-first lookup invariant and document bug fix
  - `910bc6f` - test: make HMR integration tests more stable with waitFor patterns

## Problem/Context
- Late subscriber after HMR swap got `[2, 3, 10]` instead of `[10]`
- Old shareReplay buffer was being accessed instead of fresh buffer
- Root cause: `trackedObservable` used `initialMutableId ?? store.value` priority
- `initialMutableId` was captured at wrapper creation (first HMR run)
- After HMR swap, store had new `mutable_observable_id` but it was never checked because `initialMutableId` was truthy

## Solution/Approach
1. Reversed priority in `trackedObservable.ts` to `store.value ?? initialMutableId`
2. Applied fix to both `tryConnect()` and `watchSub` callback
3. Current store value is now always preferred
4. `initialMutableId` only used as fallback before store is populated
5. Also fixed flaky Playwright HMR integration tests with proper `waitFor` patterns

## Tasks
- [x] Debug shareReplay buffer persistence bug
- [x] Identify root cause (stale initialMutableId priority)
- [x] Fix trackedObservable to prefer store value
- [x] Update wiki with new invariant
- [x] Make HMR integration tests more stable

## Files Modified
- `src/tracking/v2/hmr/2_tracked-observable.ts` - Fixed initialMutableId priority
- `src/tracking/v2/rxjs-edge-cases/shareReplay.test.ts` - Removed .fails marker, updated test comments
- `wiki/hmr-tracked-observable-test-matrix.md` - Added "Store-first lookup" invariant
- `src/vite-plugin/__tests__/hmr-integration/hmr.integration.test.ts` - Added waitFor patterns

## Key Insights
1. **Closure capture timing matters**: `initialMutableId` is captured when stable wrapper is created, but wrapper is reused across HMR - stale value persists
2. **Nullish coalescing priority**: `a ?? b` uses `a` if truthy - wrong for HMR where `a` is stale but truthy
3. **New invariant**: "Store-first lookup" - tryConnect/watchSub must prefer `store.mutable_observable_id` over `initialMutableId`
4. **Playwright stability**: Use `page.waitForFunction()` not `setTimeout` for async browser tests

## Open Questions
None - bug fixed, tests passing.

## Next Steps (from user's roadmap)
- [ ] UI development - Chrome Network Tab inspired design
- [ ] Refactor Vite plugin into 2: instrumentation debugger + HMR
- [ ] Clean up test app debugger
- [ ] Playwright screenshot coverage for UI
- [ ] Integrate into personal website with existing RxJS tools
