# Session: Stable Ref for HMR Subjects

## Goal
Make `__$("loc", () => new Subject())` return the SAME Subject reference across HMR swaps, and similarly for `trackedObservable()`.

## Current State
- **Branch**: `feature/vite-instrumentation-v2`
- **Tests**: 58 passing
- **Completed**: Phase 2 (RxJS semantics preserved), test utils extraction

## Problem/Context
- Currently `__$` returns the factory result directly
- On HMR, new Subject is created, old reference is orphaned
- External code holding old reference can't emit to new subscribers
- Same issue exists for `trackedObservable` - creates new wrapper each call

## Solution/Approach (in progress)
Store `stable_ref: WeakRef<Observable>` on `hmr_track` record:
- First `__$` call: create stable Subject, store in `hmr_track[location].stable_ref`, return it
- HMR calls: return same stable Subject from `stable_ref.deref()`
- Stable Subject should be **bi-synced** with inner Subject (not one-way forward)

### User's latest direction
- "bisynced until swap" - next on one nexts the other
- Asked about using `.add()` for linking/cleanup

## Tasks
- [ ] Add `stable_ref?: WeakRef<Observable>` to hmr_track type in 00.types.ts
- [ ] Implement bi-directional sync between stable and inner Subject
- [ ] Figure out how to use `.add()` for linking/teardown
- [ ] Update `__$` to return stable Subject
- [ ] Update `trackedObservable` to return stable Observable
- [ ] Add tests for same-reference across HMR
- [ ] Commit all session changes

## Files to Modify
- `src/tracking/v2/00.types.ts` - add stable_ref to hmr_track
- `src/tracking/v2/hmr/0_runtime.ts` - __$ stable Subject logic
- `src/tracking/v2/hmr/2_tracked-observable.ts` - stable Observable logic
- `src/tracking/v2/hmr/0_runtime.test.ts` - tests

## Key Insights
- Subject extends Observable, constructor-call-return fires, stored in observable store
- `hmr_track[location].entity_id` points to current observable
- Don't create separate Maps - use existing state structure
- User wants bi-directional sync, not one-way forwarding

## Open Questions
- How exactly to implement bi-sync? (stable$.next â†” inner$.next)
- Can we use Subscription `.add()` to link them and cleanup on swap?
- How to avoid infinite loops with bi-directional emission?

## Already Done This Session
- Phase 2: Removed complete suppression (preserve RxJS semantics)
- Extracted common test setup to `0_test-utils.ts`
- Attempted Subject patching (removed - wrong approach)
- Updated tests to use natural HMR flow (no track-update events)
