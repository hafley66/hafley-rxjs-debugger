# Session: HMR Module Scope Implementation

## Goal
Implement `hmr_module` entity + `_rxjs_debugger_module_start` for per-file HMR tracking and subscription cleanup.

## Current State
- **Branch**: `feature/vite-instrumentation-v2`
- **Tests**: 77 passing, 3 skipped
- **Key files created/modified**:
  - `src/tracking/v2/hmr/4_module-scope.ts` - NEW: ModuleScope implementation
  - `src/tracking/v2/00.types.ts` - Added `hmr_module` entity, `module_id` FK
  - `src/tracking/v2/03_scan-accumulator.ts` - Module event handlers + `share()` fix
  - `src/tracking/v2/01.patch-observable.ts` - Module events in UNTRACKED_EVENTS

## What Was Implemented

### 1. hmr_module entity
```ts
hmr_module: {
  url: string           // import.meta.url
  version: number       // bumps on each HMR reload
  prev_keys: string[]   // for orphan detection
}
```

### 2. module_id FK
- Added to `hmr_track` and `subscription` types
- Stamped by accumulator from `state.stack.hmr_module`

### 3. ModuleScope API
```ts
const __$ = _rxjs_debugger_module_start(import.meta.url)
__$("key", () => new Subject())           // track observable
__$("outer", $ => $("inner", fn))         // nested -> "outer:inner"
__$.sub("key", () => obs.subscribe())     // track subscription
__$.end()                                  // triggers orphan detection
```

### 4. Orphan/Dangling Detection
- On `hmr-module-call`: snapshot current track keys to `prev_keys`
- On `hmr-module-call-return`: diff prev vs current, mark orphans
- Dangling subs (attached to orphaned observables) get `unsubscribed_at` set

### 5. Bug Fix: share() on state$$
- Multiple subscribers (trackedSubject, trackedObservable) were causing scan to run multiple times per event
- Added `share()` to multicast state$$

## Key Insights

1. **Version is in store only** - no redundant local state, accumulator owns mutations
2. **Keys concatenate with ":"** - `__$("a", $ => $("b", ...))` produces key "a:b"
3. **Closures capture module context** - async code in callbacks uses parent's module_id
4. **share() is critical** - without it, each state$$ subscriber runs the accumulator independently

## Tasks
- [x] Add hmr_module entity type
- [x] Add module_id FK to hmr_track and subscription
- [x] Add hmr-module-call / hmr-module-call-return events
- [x] Implement _rxjs_debugger_module_start
- [x] Implement ModuleScope with __$(), .sub(), .end()
- [x] Add accumulator handlers
- [x] Implement dangling detection
- [x] Fix share() bug
- [x] Tests (8 new)

## Remaining Work
- [ ] Vite plugin: Transform user code to wrap with module scope
- [ ] Actual subscription unsubscribe (currently just marks in store)

## Open Questions
- Should orphaned observables be GC'd immediately or kept for debugging?
