# Session: Compile-Time Patching Fix

## Goal
Fix double-subscription issue in RxJS debugger by ensuring Observable patching happens immediately after class definition at compile time.

## Current State
- **Branch**: `feature/vite-instrumentation-v2`
- **Tests**: 130 passing, 3 skipped
- **Commit**: `cce4d51` - fix: patch Observable immediately after class definition

## Problem/Context
1. Double subscribe-call events being emitted for single subscription
2. Snapshot showed sub 3 and sub 4 both to wrapper (obs=2) before any inner subscriptions
3. Root cause: `originalSubscribe` was being captured incorrectly or patching happened too late
4. User had accidentally moved `originalSubscribe`/`originalPipe` outside `patchObservable` function

## Solution/Approach

### 1. Fix patchObservable structure (DONE)
- Restored `originalSubscribe` and `originalPipe` declarations inside `patchObservable` function
- They were incorrectly moved outside where Observable didn't exist at module load

### 2. Add double-patch guard (DONE)
- Added `PATCHED_PROTO` symbol to prevent patching same prototype twice
- `patchObservable` now early-returns if already patched

### 3. Move PATCH_CALL timing in Vite plugin (DONE)
- Previously: PATCH_CALL appended at end of file
- Now: PATCH_CALL inserted right after Observable IIFE ends (`}());`)
- This ensures patching runs immediately when class is defined

### 4. Remove manual patching from test setup (DONE)
- Removed `ensurePatched()` and related imports from `0_test-utils.ts`
- Compile-time patching handles it now

## Tasks
- [x] Fix patchObservable to restore originalSubscribe/originalPipe inside function
- [x] Add PATCHED_PROTO guard to prevent double-patching
- [x] Move PATCH_CALL in Vite plugin to right after Observable class
- [x] Remove patchObservable from test setup
- [x] Run tests and update snapshots

## Files Modified
- `src/tracking/v2/01.patch-observable.ts` - Added guard, kept declarations inside function
- `src/vite-plugin/v2.ts` - Insert PATCH_CALL after IIFE, not at end
- `src/tracking/v2/0_test-utils.ts` - Removed manual patching
- Various snapshot files updated

## Key Insights
1. **Order matters**: Original subscribe must be captured before ANY other code can touch it
2. **IIFE pattern**: esm5 Observable is `var Observable = (function() {...}());` - patch right after
3. **Idempotent patching**: Symbol guard makes `patchObservable` safe to call multiple times
4. **Compile-time > runtime**: Patching at compile time via Vite is more reliable than runtime prototype patching

## Open Questions
- None - fix verified with all tests passing
