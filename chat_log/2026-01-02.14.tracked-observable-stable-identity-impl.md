# 2026-01-02 - tracked-observable-stable-identity-impl

## Goal
Implement trackedObservable as the stable identity for HMR - wrapper is the tracked entity, not the ephemeral inner observable.

## Current State
- **Branch**: `feature/vite-instrumentation-v2`
- **Last commit**: `f476bda wip: trackedObservable stable identity design`
- **Tests**: Some failing due to partial implementation

## Problem/Context
- trackedObservable was invisible (created with `__withNoTrack`)
- Subscriptions pointed to ephemeral inner observable IDs (unstable across HMR)
- Internal forwarding subscription emitted send events (noise)
- Synthetic subscription context needed for defer factory scoping (hacky)

## Solution/Approach

### Architecture
1. **Track key = observable_id** - Register wrapper in `store.observable` with track key as ID
2. **User subscriptions stable** - `subscription.observable_id = "fetch$:abc"` (stable)
3. **Internal forwarding invisible** - Uses `__withNoTrack` to prevent loops
4. **Send events from wrapper** - When inner emits, send references wrapper's ID

### Store Structure
```
store.observable["0"]         = inner (of(1)) - via factory-call-return
store.observable["fetch$:abc"] = wrapper - via extended track-call-return
hmr_track["fetch$:abc"].entity_id = "0"
```

### Implementation: Extend track-call-return (Option A)
```ts
case "track-call-return": {
  const entity = state.stack.hmr_track.pop()
  // ... existing logic ...

  // Register wrapper in store.observable
  const wrapper = entity.stable_ref?.deref()
  if (wrapper) {
    state.store.observable[entity.id] = {
      id: entity.id,
      created_at: now(),
      name: state.store.observable[entity.entity_id]?.name ?? `tracked(${entity.id})`,
      obs_ref: entity.stable_ref,
    }
    observableIdMap.set(wrapper, entity.id)
  }
}
```

### Infinite Loop Prevention
Keep `__withNoTrack` for internal plumbing only:
- state$$ watcher subscription
- innerSub subscription to source
- Wrapper itself IS tracked (in store.observable)

## Tasks
- [ ] Implement accumulator changes in `track-call-return`
- [ ] Remove synthetic subscription push/pop hack from trackedObservable
- [ ] Apply same pattern to trackedSubject
- [ ] Update and verify all tests pass
- [ ] Remove suppressSend$ if not needed
- [ ] Clean up debug logging

## Files to Modify
1. `src/tracking/v2/03_scan-accumulator.ts` - extend track-call-return
2. `src/tracking/v2/hmr/2_tracked-observable.ts` - remove synthetic sub hack
3. `src/tracking/v2/hmr/3_tracked-subject.ts` - same pattern
4. `src/tracking/v2/00.types.ts` - may remove suppressSend$
5. `src/tracking/v2/01.patch-observable.ts` - may remove suppressSend$ check
6. Test files - update snapshots

## Key Insights
- Track key includes content hash â†’ if structure changes, it's a NEW track (orphan cleanup handles old)
- Inner still tracked (needed for obs_ref lookup via entity_id)
- No new event type needed - just extend accumulator logic
- `__withNoTrack` stays for internal forwarding to prevent loops, but wrapper is registered

## Open Questions
- None - design is locked, ready for implementation
