# 2026-01-03 - vite-transform-epic-planning

## Goal
Create comprehensive epic structure for HMR MVP, focusing on Vite AST transform phase.

## Current State
- **Branch**: `feature/vite-instrumentation-v2`
- **Commit**: `dda19c2` - docs: add HMR MVP epic structure and vite transform planning
- **Tests**: 85 passing, 3 skipped
- **Phases 1-3**: Complete (manual __$, swap mechanism, lifecycle management)
- **Phases 4-6**: Planned (cleanup gaps, vite transforms, e2e tests)

## Problem/Context
- Core HMR runtime complete but only works with manually instrumented code
- Need Vite plugin to auto-transform user code with `__$()` and `__$.sub()`
- Identified gaps in current implementation before proceeding

## Solution/Approach
Created epic structure at `chat_log/epics/hmr-mvp/`:
- Main board tracking all 6 phases
- Sub-epic for Vite transforms with 5 phases (A-E)
- Detailed task files for each work item

## Tasks
- [ ] Phase A: File detection + AST pattern utilities
- [ ] Phase B: Module wrapper injection (`__$` start/end)
- [ ] Phase C: Observable declaration wrapping
- [ ] Phase D: Subscription wrapping
- [ ] Phase E: Comprehensive test suite

## Files Created
- `chat_log/epics/hmr-mvp/board.md` - Main epic board
- `chat_log/epics/hmr-mvp/tasks/*.md` - Gap cleanup tasks (5 files)
- `chat_log/epics/hmr-mvp/vite-transform/board.md` - Sub-epic board
- `chat_log/epics/hmr-mvp/vite-transform/*.md` - Transform tasks (8 files)

## Files to Modify (Implementation)
- `src/vite-plugin/v2.ts` - Add user code transform hook
- Create `src/vite-plugin/user-transform.ts` - Main transform logic
- Create `src/vite-plugin/ast-utils.ts` - Detection helpers
- Create `src/vite-plugin/key-generator.ts` - Content hash key generation
- Create `src/vite-plugin/__tests__/user-transform.test.ts`

## Key Insights
1. **Key format**: `${varName}:${contentHash}` - stable across line changes
2. **Content hash**: FNV-1a on normalized AST (strip locations)
3. **Skip rules**: Already wrapped, inside __$ factory, test files, .d.ts
4. **Gaps identified but deferred**: Dead code, skipped tests, empty handlers
5. **oxc-parser already in use** - Reuse for user code transforms

## Open Questions
- Should test files be transformed by default? (Current: skip)
- ReplaySubject/AsyncSubject support? (Not in runtime yet)
- Dynamic import handling? (Deferred)
